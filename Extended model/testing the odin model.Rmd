Trying to build an MSR model with odin.dust 

```{r}
# Load libraries
library(odin.dust)
library(odin)
library(dplyr)
library (tidyr)
library(ggplot2)
```

```{r}
# Load model
gen_msr <- odin_dust("~/Library/CloudStorage/OneDrive-Charité-UniversitätsmedizinBerlin/LSTHM project/Extension/RSV_infection_NL/Extended model/Odin model.R")
```

# Running the MSIR model with dust
```{r}
p_new <- list(dt = 1, 
              # M1_sp_ini = 1191 * 0.25, M1_sm_ini = 1191 * 0.25, M1_au_ini = 1191 * 0.25, M1_wt_ini = 1191 * 0.25, 
              # M2_sp_ini = 0, M2_sm_ini = 0, M2_sm_ini = 0, M2_sm_ini = 0,
              # S_sp_ini = 0, S_sm_ini = 0, S_au_ini = 0, S_wt_ini = 0,
              # R_sp_ini = 0, R_sm_ini = 0, R_au_ini = 0, R_wt_ini = 0, # beta = 0.4, gamma = 0.1, mu = 0.1 
              winter_comp = 0.03)
msr_model <- gen_msr$new(pars = p_new ,
                         time = 1,
                         n_particles = 1L,
                         n_threads = 4L,
                         seed = 1L)

#res <- msir_model$run(365)
```

```{r}
n_times <- 2190
n_particles <- 1L
x <- array(NA, dim = c(msr_model$info()$len, n_particles, n_times))

for (t in seq_len(n_times)) {
  x[ , , t] <- msr_model$run(t)
}
time <- x[1, 1, ]
#x <- x[-1, , ]

# par(mar = c(4.1, 5.1, 0.5, 0.5), las = 1)
# cols <- c(M = "#F2862C", S = "#8c8cd9", R = "#999966")
# matplot(time, t(x[1, , ]), type = "l",
#          xlab = "Time", ylab = "Number of individuals",
#          col = cols[["M"]], lty = 1, ylim = range(x))
# matlines(time, t(x[2, , ]), col = cols[["S"]], lty = 1)
# matlines(time, t(x[3, , ]), col = cols[["R"]], lty = 1)
# legend("left", lwd = 1, col = cols, legend = names(cols), bty = "n")
```

```{r}
# Turn the result into something intelligible
x_df <- as.data.frame(x)

# Add names
x_df_names <- c("time",
                "M1_sp", "M2_sp", "S_sp", "R_sp",
                "M1_sm", "M2_sm", "S_sm", "R_sm",
                "M1_au", "M2_au", "S_au", "R_au",
                "M1_wt", "M2_wt", "S_wt", "R_wt")

x_df_w_names <- cbind(x_df_names, x_df)

# Transpose and assign names
x_transp <- data.frame(t(x_df_w_names[-1]))
colnames(x_transp) <- x_df_w_names[, 1]
```

```{r}
palette <- c("M1" = "#F2862C", "M2" = "#cc0044", "S" = "#8c8cd9", "R" = "#999966")
x_transp %>% ggplot(aes(x = time)) +
  geom_line(aes(y = M1_sp, colour = "M1")) + 
  geom_line(aes(y = M2_sp, colour = "M2")) + 
  geom_line(aes(y = S_sp, colour = "S")) + 
  geom_line(aes(y = R_sp, colour = "R")) + 
  labs(title = "Model progression for the spring cohort", x = "Age",
       y = "Number of individuals", colour = "State") +
  theme_light() +
  scale_colour_manual(values = palette)
```

```{r}
palette <- c("M1" = "#F2862C", "M2" = "#cc0044", "S" = "#8c8cd9", "R" = "#999966")
x_transp %>% ggplot(aes(x = time)) +
  geom_line(aes(y = M1_sm, colour = "M1")) + 
  geom_line(aes(y = M2_sm, colour = "M2")) + 
  geom_line(aes(y = S_sm, colour = "S")) + 
  geom_line(aes(y = R_sm, colour = "R")) + 
  labs(title = "Model progression for the summer cohort", x = "Age",
       y = "Number of individuals", colour = "State") +
  theme_light() +
  scale_colour_manual(values = palette)
```

```{r}
palette <- c("M1" = "#F2862C", "M2" = "#cc0044", "S" = "#8c8cd9", "R" = "#999966")
x_transp %>% ggplot(aes(x = time)) +
  geom_line(aes(y = M1_au, colour = "M1")) + 
  geom_line(aes(y = M2_au, colour = "M2")) + 
  geom_line(aes(y = S_au, colour = "S")) + 
  geom_line(aes(y = R_au, colour = "R")) + 
  labs(title = "Model progression for the autumn cohort", x = "Age",
       y = "Number of individuals", colour = "State") +
  theme_light() +
  scale_colour_manual(values = palette)
```

```{r}
palette <- c("M1" = "#F2862C", "M2" = "#cc0044", "S" = "#8c8cd9", "R" = "#999966")
x_transp %>% ggplot(aes(x = time)) +
  geom_line(aes(y = M1_wt, colour = "M1")) + 
  geom_line(aes(y = M2_wt, colour = "M2")) + 
  geom_line(aes(y = S_wt, colour = "S")) + 
  geom_line(aes(y = R_wt, colour = "R")) + 
  labs(title = "Model progression for the winter cohort", x = "Age",
       y = "Number of individuals", colour = "State") +
  theme_light() +
  scale_colour_manual(values = palette)
```

```{r}
# Check that the total is constant
x_transp <- x_transp %>% group_by(time) %>%
  mutate(N = sum(M1_sp, M2_sp, S_sp, R_sp,
                 M1_sm, M2_sm, S_sm, R_sm,
                 M1_au, M2_au, S_au, R_au,
                 M1_wt, M2_wt, S_wt, R_wt))
```

```{r}
# Get total seroconverted at an age
x_transp <- x_transp %>% group_by(time) %>%
  mutate(total_sero = sum(R_sp, R_sm, R_au, R_wt))

# Get total incident cases at an age, total and by season
x_transp <- x_transp %>% ungroup() %>%
  mutate(prev_totalcases = lag(total_sero),
         daily_cases = total_sero - prev_totalcases,
         prev_totalcases_sp = lag(R_sp),
         daily_cases_sp = R_sp - prev_totalcases_sp,
         prev_totalcases_sm = lag(R_sm),
         daily_cases_sm = R_sm - prev_totalcases_sm,
         prev_totalcases_au = lag(R_au),
         daily_cases_au = R_au - prev_totalcases_au,
         prev_totalcases_wt = lag(R_wt),
         daily_cases_wt = R_wt - prev_totalcases_wt) %>%
  select(!c(prev_totalcases, prev_totalcases_sp, prev_totalcases_sm,
            prev_totalcases_au, prev_totalcases_wt))

```

```{r}
# Same thing but using odin instead of odin.dust
msr_test <- odin("~/Library/CloudStorage/OneDrive-Charité-UniversitätsmedizinBerlin/LSTHM project/Extension/RSV_infection_NL/Extended model/Odin model.R")

test <- msr_test$new(M1_sp_ini = 1191 * 0.25, M1_sm_ini = 1191 * 0.25, 
                     M1_au_ini = 1191 * 0.25, M1_wt_ini = 1191 * 0.25, 
                     winter_comp = 0.03,  mu = 0.1)

sir_col <- c("#8c8cd9", "#cc0044", "#999966", "turquoise")
x_res <- test$run(0:2000)
par(mar = c(4.1, 5.1, 0.5, 0.5), las = 1)
matplot(x_res[, 1], x_res[, 3:6], xlab = "Time", ylab = "Number of individuals",
        type = "l", col = sir_col, lty = 1)
legend("topright", lwd = 1, col = sir_col, legend = c("M1", "M2", "S", "R"), bty = "n")
```

```{r}
# Trying to read in and the data and put it in the right format
library (mcstate)
data <- read.csv("https://raw.githubusercontent.com/Stijn-A/RSV_serology/master/data/infection_status_csv.txt",
                 sep=",")

# Get number of cases by age
incidence_data <- data %>% select (age_days, infection) %>%
  group_by(age_days) %>%
  summarise(infection = sum(infection),
            N = n()) %>%
  ungroup() %>%
  mutate(cum_infection = cumsum(infection)) %>%
  arrange(age_days)

# Put it in the right format?
model_data <- particle_filter_data(data = incidence_data,
                                 time = "age_days",
                                 rate = 1)
rmarkdown::paged_table(model_data)
```

```{r}
# Comparison function
case_compare <- function(state, observed, pars = NULL){
   exp_noise <- 1e6
  
  total_sero_modelled <- state[17, , drop = T]
  seroprevalence_observed <- observed$cum_infection
  lambda <- total_sero_modelled  +
  rexp(n = length(total_sero_modelled ), rate = exp_noise)
  dpois(x = seroprevalence_observed, lambda = lambda, log = T) # This is OK for incidence, not sure about prevalence
  
}

```

```{r}
# Set up a particle filter
n_particles <- 100
filter <- particle_filter$new(data = model_data,
                              model = gen_msr, 
                              n_particles = n_particles,
                              compare = case_compare,
                              seed = 1L)
```

```{r}
# Run the filter
dt = 1
filter$run(save_history = T, pars = list(dt=dt)) # This is so low! (-90716.07)
```

```{r}
plot_particle_filter <- function(history, true_history, times, obs_end = NULL) {
  if (is.null(obs_end)) {
    obs_end <- max(times)
  }

  par(mar = c(4.1, 5.1, 0.5, 0.5), las = 1)
  cols <- c(M1_sp = "#8c8cd9", M2_sp = "turquoise", S_sp = "#cc0044", R_sp = "#999966", R_all = "pink")
  matplot(times, t(history[2, , -1]), type = "l",
          xlab = "Time", ylab = "Number of individuals",
          col = cols[["M1_sp"]], lty = 1, #ylim = range(history)
          ylim = c(-1, 300))
  matlines(times, t(history[3, , -1]), col = cols[["M2_sp"]], lty = 1)
  matlines(times, t(history[4, , -1]), col = cols[["S_sp"]], lty = 1)
  matlines(times, t(history[5, , -1]), col = cols[["R_sp"]], lty = 1)
  matlines(times, t(history[17, , -1]), col = cols[["R_all"]], lty = 1)
  matpoints(t(true_history[1]), t(true_history[7]), pch = 19, cols = c("black", "black"))
  legend("left", lwd = 1, col = cols, legend = names(cols), bty = "n")
  
}

plot_particle_filter(filter$history(), model_data, incidence_data$age_days)
```
```{r}
# True with other initial conditions to see if it's any better (it's not)
filter$run(save_history = TRUE, pars = list(dt = dt, 
                                            M1_sp_ini = 1191 * 0.25, 
                                            M1_sm_ini = 1191 * 0.25,
                                            M1_au_ini = 1191 * 0.25,
                                            M1_wt_ini = 1191 * 0.25))
```
